name: clinical-compound-table-pages

on:
  workflow_dispatch:
    inputs:
      hnid:
        description: "PubChem HNID"
        required: false
        default: "1856916"
      extra_hnids:
        description: "Comma-separated extra HNIDs"
        required: false
        default: ""
      limit_cids:
        description: "Limit CIDs for this run (empty = all, recommended for production)"
        required: false
        default: ""
      limit_per_collection:
        description: "Max rows per collection per CID"
        required: false
        default: "200"
      table_mode:
        description: "HTML table mode"
        required: false
        default: "datatables"
      image_size:
        description: "PNG size for base64 images"
        required: false
        default: "400x400"
      retention_days:
        description: "Delete history snapshots older than N days"
        required: false
        default: "365"
  schedule:
    - cron: "30 3 * * *"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: clinical-compound-table-pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Build dataset
        env:
          HNID: ${{ github.event.inputs.hnid || '1856916' }}
          EXTRA_HNIDS: ${{ github.event.inputs.extra_hnids || '' }}
          LIMIT_CIDS: ${{ github.event.inputs.limit_cids || '' }}
          LIMIT_PER_COLLECTION: ${{ github.event.inputs.limit_per_collection || '200' }}
          IMAGE_SIZE: ${{ github.event.inputs.image_size || '400x400' }}
        run: |
          mkdir -p out/pubchem_trials_dataset_gh
          EXTRA_ARGS=""
          if [ -n "${EXTRA_HNIDS}" ]; then
            EXTRA_ARGS="--extra-hnids ${EXTRA_HNIDS}"
          fi

          LIMIT_ARGS=""
          if [ -n "${LIMIT_CIDS}" ]; then
            LIMIT_ARGS="--limit-cids ${LIMIT_CIDS}"
          fi

          python scripts/export_pubchem_trials_dataset.py \
            --hnid "${HNID}" \
            $EXTRA_ARGS \
            $LIMIT_ARGS \
            --collections clinicaltrials,clinicaltrials_eu,clinicaltrials_jp \
            --limit-per-collection "${LIMIT_PER_COLLECTION}" \
            --image-size "${IMAGE_SIZE}" \
            --out-dir out/pubchem_trials_dataset_gh

      - name: Update PubChem trials snapshots
        env:
          RETENTION_DAYS: ${{ github.event.inputs.retention_days || '365' }}
        run: |
          set -euo pipefail
          python scripts/update_pubchem_trials_history.py \
            --trials-file out/pubchem_trials_dataset_gh/trials.json \
            --state-file snapshots/pubchem_trials/collection_state.json \
            --latest-file snapshots/pubchem_trials/latest/trials.json \
            --history-dir snapshots/pubchem_trials/history \
            --retention-days "${RETENTION_DAYS}" \
            --changed-flag-path /tmp/pubchem_trials_changed.txt

      - name: Commit and push snapshots
        run: |
          set -euo pipefail
          if git diff --quiet -- snapshots/pubchem_trials; then
            echo "No PubChem snapshot changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add snapshots/pubchem_trials

          COLLECTED_AT=$(python - <<'PY'
          import json
          from pathlib import Path
          state = json.loads(Path("snapshots/pubchem_trials/collection_state.json").read_text(encoding="utf-8"))
          print(state.get("last_collected_at", "unknown"))
          PY
          )

          git commit -m "chore(data): update pubchem trials snapshots (${COLLECTED_AT})"
          git push origin HEAD:${GITHUB_REF_NAME}

      - name: Build table HTML
        env:
          TABLE_MODE: ${{ github.event.inputs.table_mode || 'datatables' }}
        run: |
          python scripts/build_pubchem_trials_table.py \
            --in-json out/pubchem_trials_dataset_gh/trials.json \
            --mode "${TABLE_MODE}" \
            --out-html out/pubchem_trials_dataset_gh/index.html \
            --title "Clinical Trials Table"

      - name: Prepare Pages artifact
        run: |
          mkdir -p site
          cp out/pubchem_trials_dataset_gh/index.html site/index.html
          cp out/pubchem_trials_dataset_gh/trials.json site/trials.json
          cp out/pubchem_trials_dataset_gh/trials.csv site/trials.csv
          cp out/pubchem_trials_dataset_gh/summary.json site/summary.json
          cp out/pubchem_trials_dataset_gh/cids.txt site/cids.txt

      - name: Configure Pages
        uses: actions/configure-pages@v5
        with:
          enablement: true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
