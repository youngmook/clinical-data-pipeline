name: ctgov-collect

on:
  workflow_dispatch:
    inputs:
      hnid:
        description: "PubChem HNID"
        required: false
        default: "3647573"
      limit_cids:
        description: "Optional CID limit (empty = no limit)"
        required: false
        default: ""
      limit_ncts:
        description: "Optional NCT fetch limit (empty = no limit)"
        required: false
        default: ""
  schedule:
    - cron: "15 3 * * *"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ctgov-pages
  cancel-in-progress: false

jobs:
  collect-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Restore previous collected data cache
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: out/ctgov_docs_schedule
          key: ctgov-data-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            ctgov-data-${{ runner.os }}-

      - name: Collect CTGov docs (step1-3)
        env:
          HNID: ${{ github.event.inputs.hnid || '3647573' }}
          LIMIT_CIDS: ${{ github.event.inputs.limit_cids || '' }}
          LIMIT_NCTS: ${{ github.event.inputs.limit_ncts || '' }}
        run: |
          set -euo pipefail
          EXTRA_ARGS=""
          if [ -n "${LIMIT_CIDS}" ]; then
            EXTRA_ARGS="${EXTRA_ARGS} --limit-cids ${LIMIT_CIDS}"
          fi
          if [ -n "${LIMIT_NCTS}" ]; then
            EXTRA_ARGS="${EXTRA_ARGS} --limit-ncts ${LIMIT_NCTS}"
          fi

          PYTHONUNBUFFERED=1 python -u scripts/collect_ctgov_docs.py \
            --hnid "${HNID}" \
            --folder-name ctgov_docs_schedule \
            --out-root out \
            --use-ctgov-fallback \
            --resume \
            --show-progress \
            --progress-every 50 \
            ${EXTRA_ARGS}

      - name: Build normalized clinical dataset
        run: |
          python scripts/build_clinical_dataset.py \
            --links-file out/ctgov_docs_schedule/cid_nct_links.jsonl \
            --studies-file out/ctgov_docs_schedule/studies.jsonl \
            --compounds-file out/ctgov_docs_schedule/compounds.jsonl \
            --out-dir out/ctgov_docs_schedule/final

      - name: Build static studies table page
        run: |
          python scripts/build_studies_table.py \
            --dataset-csv out/ctgov_docs_schedule/final/clinical_compound_trials.csv \
            --out-dir docs/data \
            --title "Clinical Compound Trials (Auto-updated)"

      - name: Update studies history and latest data snapshot
        run: |
          set -euo pipefail
          python scripts/update_studies_history.py \
            --studies-file out/ctgov_docs_schedule/studies.jsonl \
            --state-file data/ctgov/collection_state.json \
            --latest-file data/ctgov/studies.jsonl \
            --history-dir data/ctgov/history \
            --changed-flag-path /tmp/studies_changed.txt

          mkdir -p data/ctgov/final
          cp out/ctgov_docs_schedule/final/clinical_compound_trials.csv data/ctgov/final/clinical_compound_trials.csv
          cp out/ctgov_docs_schedule/final/clinical_compound_trials.jsonl data/ctgov/final/clinical_compound_trials.jsonl

      - name: Commit and push updated snapshots (if changed)
        run: |
          set -euo pipefail
          if git diff --quiet -- data/ctgov docs/data; then
            echo "No snapshot changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/ctgov docs/data

          COLLECTED_AT=$(python - <<'PY'
          import json
          from pathlib import Path
          state = json.loads(Path("data/ctgov/collection_state.json").read_text(encoding="utf-8"))
          print(state.get("last_collected_at", "unknown"))
          PY
          )

          git commit -m "chore(data): update CTGov snapshots (${COLLECTED_AT})"
          git push origin HEAD:${GITHUB_REF_NAME}

      - name: Save collected data cache
        uses: actions/cache/save@v4
        with:
          path: out/ctgov_docs_schedule
          key: ctgov-data-${{ runner.os }}-${{ github.run_id }}

      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          enablement: true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/data

  deploy-pages:
    runs-on: ubuntu-latest
    needs: collect-and-build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
